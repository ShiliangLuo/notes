# 浏览器缓存

浏览器缓存就是当浏览器通过`http`获取资源后，将资源存储在本地的行为

## 缓存方式

浏览器在向服务器请求资源时，会先判断是否命中强制缓存，再判断是否命中协商缓存

1. 强制缓存

   浏览器会根据缓存资源的`header`中的`expires`和`cache-control`判断是否命中强制缓存，如果命中则会直接使用缓存资源而不会向服务器发送请求。`expires`和`cache-control`可以同时启用，同时启用的时候`cache-control`的优先级高。

   * expires

     `http1.0`规范，是一个GMT格式的绝对时间，在此时间之前，则命中缓存。存在缺陷，由于失效时间是绝对时间，当服务器与客户端时间偏差较大时，会导致缓存混乱

   * cache-control

     1. max-age: 相对时间，在这个时间范围内命中强制缓存
     2. no-cache: 表示使用协商缓存
     3. no-store: 不使用缓存，每次都向服务器请求数据
     4. public: 可以被所有用户缓存，包括终端用户和CDN等中间代理服务器
     5. private: 只能被终端用户的浏览器缓存，不允许CDN等中间代理服务器对其进行缓存

2. 协商缓存

   当没有命中强制缓存的时候，浏览器会发送请求，根据`header`中的`Last-Modified/If-Modified-Since`和`ETag/If-None-Match`判断是否命中协商缓存。如果命中，此时`http`状态码是`304`

   * Last-Modified/If-Modified-Since
   
     浏览器第一次请求一个资源的时候，服务器的响应头里会加上`Last-Modified`，标识资源的最后修改时间。当浏览器再次请求该资源的时候，请求头会加上`If-Modified-Since`，值为之前缓存的`Last-Modified`，服务器收到`If-Modified-Since`后，根据资源的最后修改时间，判断是否命中缓存
   
   * ETag/If-None-Match
   
     `ETag/If-None-Match`是检验码，服务器根据浏览器发送的`If-None-Match`判断是否命中缓存

## 三级缓存策略

* 先在内存中查找，如果有，直接加载
* 如果内存中不存在，去硬盘中查找，如果有，直接加载
* 如果硬盘中也没有，就进行网络请求
* 将请求获取到的资源缓存到内存和硬盘

## 总结

当浏览器再次访问一个已经访问过的资源时，它会：

1. 看看是否命中强缓存，如果命中，就直接使用缓存了
2. 如果没有命中强缓存，就发请求到服务器检查是否命中协商缓存
3. 如果命中协商缓存，服务器会返回 304 告诉浏览器使用本地缓存
4. 否则，返回最新的资源